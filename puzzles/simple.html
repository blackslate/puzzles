<!DOCTYPE html>
<html lang=en>
<head>
  <meta charset="utf-8">
  <title>Puzzle nÂ° 13</title>
  <style>
    html, body {
      margin:0;
      padding:0;
      overflow:hidden;
      height: 100%;
      background:#200;
      text-align:center;
    }
    body * {
      -webkit-touch-callout: none;
      -webkit-user-select: none;
      -khtml-user-select: none;
      -moz-user-select: none;
      -ms-user-select: none;
      user-select: none;
    }
    main {
     position:absolute;
     width:100vmin;
     height:100vmin;
     left:50%;
     top:50%;
     margin-left:-50vmin;
     margin-top:-50vmin;
     background:#000;
     color:#fff;
    }
    p {
      font-family: "Courier", monospace;
      font-size: 24vmin;
      position:absolute;
      margin: 0;     
      margin-top:38vmin;
    }
    svg {
      position: absolute;
      top:0;
      left:0;
      width:100%;
      height: 100%;
    }
    span.red{
      color: #fcc;
      opacity: 0.3;  
      animation: glow .5s infinite alternate;
    }
    span.visible{
      color:green;
    }
    svg#cell_CO {
      width: 100%;
      left: 0;
      top: 0;
      height: 100%;
    }
    svg#cell_CO.hidden{
      display: none;
    }
    svg#decay{
      width:100%;
      height: 100%;
      display:none;
    }

    @keyframes glow {
      to {
        text-shadow: 0px 0px 25px rgba(255, 0, 0, 1);
      }
    }
  </style>  
</head>
<body>
<main>
<?xml version="1.0"?>
<svg
  xmlns="http://www.w3.org/2000/svg" 
  width="100"
  height="100"
  viewbox="0 0 100 100">

  <defs>
    <radialGradient
      id="bump"
      cx="50%"
      cy="50%"
      r="100%"
      fx="25%"
      fy="25%">
      <stop offset="0%" style="stop-color:#ccc" />
      <stop offset="100%" style="stop-color:#666" />
    </radialGradient>
    <radialGradient
      id="pulse"
      cx="50%"
      cy="50%"
      r="100%"
      fx="25%"
      fy="25%">
      <stop offset="0%" style="stop-color:#f00" />
      <stop offset="100%" style="stop-color:#900" />
    </radialGradient>
    <circle
      id="grey"
      cx="15"
      cy="15"
      r="15"
      fill="#fff"
      opacity="0.1"
    />
   <circle
      id="line"
      cx="15"
      cy="15"
      r="15"
      stroke="#666"
      stroke-width="1"
      fill="none"
    />
    <circle
      id="fill"
      cx="15"
      cy="15"
      r="15"
      fill="url(#bump)"
    />
    <circle
      id="red"
      cx="15"
      cy="15"
      r="15"
      fill="url(#pulse)"
    />
    <g
      id="*"
      width="80"
      height="130"
      transform="scale(0.1)"
      >
      <use x=   "0"   y="0" xlink:href="#line"/>
      <use x=   "0"  y="50" xlink:href="#line"/>
      <use x=   "0" y="100" xlink:href="#line"/>
      <use x=  "50"   y="0" xlink:href="#line"/>
      <use x=  "50"  y="50" xlink:href="#line"/>
      <use x=  "50" y="100" xlink:href="#line"/>
    </g>
    <g
      id="**"
      width="200"
      height="130"
      transform="scale(0.1)"
      >
      <use x=   "0"   y="0" xlink:href="#line"/>
      <use x=   "0"  y="50" xlink:href="#line"/>
      <use x=   "0" y="100" xlink:href="#line"/>
      <use x=  "50"   y="0" xlink:href="#line"/>
      <use x=  "50"  y="50" xlink:href="#line"/>
      <use x=  "50" y="100" xlink:href="#line"/>
      <use x= "150"   y="0" xlink:href="#line"/>
      <use x= "150"  y="50" xlink:href="#line"/>
      <use x= "150" y="100" xlink:href="#line"/>
      <use x= "200"   y="0" xlink:href="#line"/>
      <use x= "200"  y="50" xlink:href="#line"/>
      <use x= "200" y="100" xlink:href="#line"/>
    </g>
 
    <g
      id="M"
      width="80"
      height="130"
      transform="scale(0.1)"
      >
      <use x=   "0"   y="0" xlink:href="#grey"/>
      <use x=   "0"  y="50" xlink:href="#line"/>
      <use x=   "0" y="100" xlink:href="#grey"/>
      <use x=  "50"   y="0" xlink:href="#grey"/>
      <use x=  "50"  y="50" xlink:href="#line"/>
      <use x=  "50" y="100" xlink:href="#line"/>
    </g>
    <g
      id="P"
      width="80"
      height="130"
      transform="scale(0.1)"
      >
      <use x=   "0"   y="0" xlink:href="#grey"/>
      <use x=   "0"  y="50" xlink:href="#grey"/>
      <use x=   "0" y="100" xlink:href="#grey"/>
      <use x=  "50"   y="0" xlink:href="#grey"/>
      <use x=  "50"  y="50" xlink:href="#line"/>
      <use x=  "50" y="100" xlink:href="#line"/>
    </g>
    <g
      id="L"
      width="80"
      height="130"
      transform="scale(0.1)"
      >
      <use x=   "0"   y="0" xlink:href="#grey"/>
      <use x=   "0"  y="50" xlink:href="#grey"/>
      <use x=   "0" y="100" xlink:href="#grey"/>
      <use x=  "50"   y="0" xlink:href="#line"/>
      <use x=  "50"  y="50" xlink:href="#line"/>
      <use x=  "50" y="100" xlink:href="#line"/>
    </g>
    <g
      id="E"
      width="80"
      height="130"
      transform="scale(0.1)"
      >
      <use x=   "0"   y="0" xlink:href="#grey"/>
      <use x=   "0"  y="50" xlink:href="#line"/>
      <use x=   "0" y="100" xlink:href="#line"/>
      <use x=  "50"   y="0" xlink:href="#line"/>
      <use x=  "50"  y="50" xlink:href="#grey"/>
      <use x=  "50" y="100" xlink:href="#line"/>
    </g>
    <g
      id="X"
      width="80"
      height="130"
      transform="scale(0.1)"
      >
      <use x=   "0"   y="0" xlink:href="#red"/>
      <use x=   "0"  y="50" xlink:href="#line"/>
      <use x=   "0" y="100" xlink:href="#red"/>
      <use x=  "50"   y="0" xlink:href="#red"/>
      <use x=  "50"  y="50" xlink:href="#line"/>
      <use x=  "50" y="100" xlink:href="#red"/>
    </g>
    <filter id="fractalNoise" filterUnits="userSpaceOnUse" x="0" y="0" width="100" height="100">
      <feTurbulence
       type="fractalNoise"
       baseFrequency=".1 .1"
       numOctaves="1"
       seed="0"
       stitchTiles="noStitch"
       in="SourceGraphic">
        <animate
         attributeName="seed"
         calcMode="linear"
         values="0;100"
         begin="0s"
         dur="1s"
         repeatCount="indefinite"
        />
      </feTurbulence>
      <feColorMatrix type="saturate" values="0" in="f1">
    </filter>
  </defs>

  <rect filter="url(#fractalNoise)" width="100" height="100" opacity="0.2" />
  <g transform="translate(3.25,66.67) scale(0.96)">
    <use              x= "0" y="0" xlink:href="#**"/>
    <use id="cell_M"  x= "30" y="0" xlink:href="#*"/>
    <use id="cell_P"  x= "45" y="0" xlink:href="#*"/>
    <use id="cell_L"  x= "60" y="0" xlink:href="#*"/>
    <use id="cell_E"  x= "75" y="0" xlink:href="#*"/>
    <use id="cell_X"  x= "90" y="0" xlink:href="#*"/>
  </g>
</svg>

<!-- HARD-CODED DOT POSITIONS, SLIGHTLY TOO BIG -->
<svg
  id="cell_CO"
  class="hidden"
  xmlns="http://www.w3.org/2000/svg" 
  viewbox="0 0 1000 1000">
  <use x=  "32" y="667" xlink:href="#fill"/>
  <use x=  "32" y="715" xlink:href="#line"/>
  <use x=  "32" y="763" xlink:href="#line"/>
  <use x=  "80" y="667" xlink:href="#fill"/>
  <use x=  "80" y="715" xlink:href="#line"/>
  <use x=  "80" y="762" xlink:href="#line"/>

  <use x= "176" y="667" xlink:href="#fill"/>
  <use x= "176" y="715" xlink:href="#line"/>
  <use x= "176" y="762" xlink:href="#fill"/>
  <use x= "224" y="667" xlink:href="#line"/>
  <use x= "224" y="715" xlink:href="#fill"/>
  <use x= "224" y="762" xlink:href="#line"/>
</svg>

<p><span id="SI">CO</span><span>M</span><span>P</span><span>L</span><span>E</span><span class="red">X</span></p>

<svg id="decay" width="1000" height="1000" viewbox="0 0 1000 1000">
  <circle cx="935" cy="525" r="15" fill="url(#pulse)">
    <animate
      attributeName="cx"
      attributeType="XML"
      from="935" to="535"
      dur="1s"
      begin="indefinite" 
      fill="freeze" />
    <animate
      attributeName="cy"
      attributeType="XML"
      from="525" to="-15"
      dur="1s"
      begin="indefinite" 
      fill="freeze" />
  </circle>
  <circle cx="935" cy="525" r="15" fill="url(#pulse)">
    <animate
      attributeName="cx"
      attributeType="XML"
      from="935" to="534"
      dur="1s"
      begin="indefinite" 
      fill="freeze" />
    <animate
      attributeName="cy"
      attributeType="XML"
      from="525" to="1065"
      dur="1s"
      begin="indefinite" 
      fill="freeze" />
  </circle>
  <circle cx="980" cy="460" r="15" fill="url(#pulse)">
    <animate
      attributeName="cx"
      attributeType="XML"
      from="980" to="580"
      dur="1s"
      begin="indefinite" 
      fill="freeze" />
    <animate
      attributeName="cy"
      attributeType="XML"
      from="460" to="-80"
      dur="1s"
      begin="indefinite" 
      fill="freeze" />
  </circle>
  <circle cx="980" cy="590" r="15" fill="url(#pulse)">
    <animate
      attributeName="cx"
      attributeType="XML"
      from="980" to="580"
      dur="1s"
      begin="indefinite" 
      fill="freeze" />
    <animate
      attributeName="cy"
      attributeType="XML"
      from="590" to="1130"
      dur="1s"
      begin="indefinite" 
      fill="freeze" />
  </circle>
</svg>
</main>

<script>
;(function () {
  var xlinkNS = "http://www.w3.org/1999/xlink"
  var body = document.body // querySelector("p")
  var SI = document.querySelector("#SI")
  var SICell = document.querySelector("#cell_CO")
  var SIOn = false
  var dots = []
  var dotLUT = {}
  var transforms = []
  var corners = []
  var cells = [] // 0-5 for 1st cell; 6-11 for second cell
  var current
    , cell
    , transforms

  body.onmousedown = body.ontouchstart = checkTarget

  ;(function initializeDraggableDots() {
    var collection = document.querySelectorAll("svg#cell_CO use")
    var cell
    for (var ii = 0, dot; dot = collection[ii]; ii += 1) {
      dots.push(dot)
      dotLUT[ii] = ii
      transforms.push ({ x: 0, y: 0})
      corners.push({ x: dot.x.animVal.value, y: dot.y.animVal.value })
      cells.push(hrefIsFill(dot))
    } 
  })()

  function checkTarget(event) {
    event.preventDefault()
    var target = event.target

    if (target.correspondingUseElement) {
      // This is SVG, and we're in Internet Explorer
      target = target.correspondingUseElement
      startDrag(event)
    } else {
      var nodeName = target.nodeName.toLowerCase()
      if (nodeName === "span") {
        treatLetterClick(event)
      } else if (nodeName === "use") {
        startDrag(event)
      }
    }

    function treatLetterClick(event) {
      if (target !== SI && SIOn) {
        hideSI()
        // SIOn may be true if: co is showing, click on SI
        // Otherwise SIOn is false
      }

      rolloverLetter(event, true)

      function rolloverLetter(event, isClick) {
        var target = event.target
        if (target.correspondingUseElement) {
          // This is SVG, and we're in Internet Explorer
          return
        } else if (target.nodeName.toLowerCase() !== "span") {
          return
        } 

        if (!isClick && target === current) {
          // We're just moving over the same letter (group)
          return
        } else if (cell) {
          // We've rolled to a new letter (group)
          hideCell(event, true)
        }

        showCell(target)
        
        function showCell(target) {
          current = target

          if (target === SI) {
            SICell.className.baseVal = ""
            cell = SICell
          } else {
            var text = target.innerHTML
            var id ="#"+text
            cell = document.querySelector("#cell_" + text)
            cell.setAttributeNS(xlinkNS, "xlink:href", id)
          }
      
          body.onmousemove = body.ontouchmove = rolloverLetter
          body.onmouseup = body.ontouchend = hideCell
        }

        function hideCell(event, isRollover) {
           if (cell === SICell && isRollover) {
             hideSI()
           } else {
             cell.setAttributeNS(xlinkNS, "xlink:href", "#*")
           } 

           if (target === SI) {
            toggleSI(isRollover)

          } else {
            SIOn = false
            current = null
            cell = null
          }

          body.onmouseup = body.ontouchend = body.onmousemove = body.ontouchmove = null
        }

        function toggleSI(isRollover) {
          if (SIOn) {
            if (isRollover) {
              // Called immediately after click
            } else {
              // Only true if co was already showing, the click was on
              // SI and it hasn't moved off, and the mouse has just been
              // released
              hideSI()
              current = null
              cell = null
            }
            return
          } else {
            SICell.className.baseVal = ""

            if (!isRollover) {
              SIOn = true
              cell = false
            }
          }
        }
      }

      function hideSI() {
        SIOn = false
        SICell.className.baseVal = "hidden"
      }
    }

    function startDrag(event) {
      if (!hrefIsFill(target)) {
        return
      }

      var index = dots.indexOf(target)
      var dotTransform = transforms[index]
      var transformX = dotTransform.x
      var transformY = dotTransform.y

      var clickX = event.pageX
      var clickY = event.pageY
      var rect = SICell.getBoundingClientRect()
      var width = SICell.viewBox.animVal.width
      var scale = width / rect.width
      var deltaX
        , deltaY


      body.onmousemove = body.ontouchmove = drag
      body.onmouseup = body.ontouchend = stopDrag

      function drag(event) {
        deltaX = (event.pageX - clickX) * scale + transformX
        deltaY = (event.pageY - clickY) * scale + transformY
        transform = "translate(" + deltaX + " " + deltaY + ")"
        target.setAttributeNS(null, "transform", transform)
      }

      function stopDrag() {
        var home = corners[index]
        var x = home.x + deltaX
        var y = home.y + deltaY

        var dropIndex = getDropCornerIndex(x, y)
        if (dropIndex < 0) {
          // Return the dot to where it came frome
          deltaX = transformX
          deltaY = transformY
        } else {
          // Move the dot to the empty location
          cells[dotLUT[index]] = false
          cells[dropIndex] = true
          dotLUT[index] = dropIndex
          deltaX = corners[dropIndex].x - corners[index].x
          deltaY = corners[dropIndex].y - corners[index].y
          updateLetters()
        }

        transform = "translate(" + deltaX + " " + deltaY + ")"
        target.setAttributeNS(null, "transform", transform)
        
        body.onmousemove = body.ontouchmove = body.onmouseup = body.ontouchend = null
        dotTransform.x = deltaX
        dotTransform.y = deltaY

        function getDropCornerIndex(x, y) {
          var max2 = 10000000
          var cornerIndex = -1
          var deltaX
            , deltaY
            , delta2
            , filled

          corners.forEach(function (corner, index) {
            deltaX = corner.x - x
            deltaY = corner.y - y
            delta2 = deltaX * deltaX + deltaY * deltaY
            if (max2 > delta2) {
              max2 = delta2
              cornerIndex = index
            }
          })

          filled = cells[cornerIndex]
          if (max2 > 400 || filled) {
            cornerIndex = -1
          }

          return cornerIndex
        }

        // function set(svgItem, domain, key, value) {
        //   if (svgItem.setAttributeNS) {
        //     svgItem.setAttributeNS(domain, key, value)
        //   } else {
        //     // Internet Explorer
            
        //   }
        // }

        function updateLetters() {
          var si = getLetter(0) + getLetter(6)
          SI.innerHTML = si

          if (si === "SI") {
            showSolution()
          }

          function getLetter(n) {
            if (!cells[n + 5]) {
              if (!cells[n + 4]) {
                if (!cells[n + 3]) {
                  if (!cells[n + 2]) {       
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 0
                        return "&nbsp;"
                      } else { // 1
                        return "A"
                      }
                    } else {
                      if (!cells[n + 0]) { // 2
                        return "1"
                      } else { // 3
                        return "B"
                      }
                    }
                  } else {
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 4
                        return "'"
                      } else { // 5
                        return "K"
                      }
                    } else {
                      if (!cells[n + 0]) { // 6
                        return "2"
                      } else { // 7
                        return "L"
                      }
                    }
                  }
                } else {
                  if (!cells[n + 2]) {       
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 8
                        return "@"
                      } else { // 9
                        return "C"
                      }
                    } else {
                      if (!cells[n + 0]) { // 10
                        return "I"
                      } else { // 11
                        return "F"
                      }
                    }
                  } else {
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 12
                        return "/"
                      } else { // 13
                        return "M"
                      }
                    } else {
                      if (!cells[n + 0]) { // 14
                        return "S"
                      } else { // 15
                        return "P"
                      }
                    }
                  }
                }
              } else {               
                if (!cells[n + 3]) { 
                  if (!cells[n + 2]) {       
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 16
                        return '"'
                      } else { // 17
                        return "E"
                      }
                    } else {
                      if (!cells[n + 0]) { // 18
                        return "3"
                      } else { // 19
                        return "H"
                      }
                    }
                  } else {
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 20
                        return "9"
                      } else { // 21
                        return "O"
                      }
                    } else {
                      if (!cells[n + 0]) { // 22
                        return "6"
                      } else { // 23
                        return "R"
                      }
                    }
                  }
                } else {
                  if (!cells[n + 2]) {       
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 24
                        return "^"
                      } else { // 25
                        return "D"
                      }
                    } else {
                      if (!cells[n + 0]) { // 26
                        return "J"
                      } else { // 27
                        return "G"
                      }
                    }
                  } else {
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 28
                        return ">"
                      } else { // 29
                        return "N"
                      }
                    } else {
                      if (!cells[n + 0]) { // 30
                        return "T"
                      } else { // 31
                        return "Q"
                      }
                    }
                  }
                }
              }
            } else {         
              if (!cells[n + 4]) {
                if (!cells[n + 3]) {
                  if (!cells[n + 2]) {       
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 32
                        return ","
                      } else { // 33
                        return "*"
                      }
                    } else {
                      if (!cells[n + 0]) { // 34
                        return "5"
                      } else { // 35
                        return "<"
                      }
                    }
                  } else {
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 36
                        return "-"
                      } else { // 37
                        return "U"
                      }
                    } else {
                      if (!cells[n + 0]) { // 38
                        return "8"
                      } else { // 39
                        return "V"
                      }
                    }
                  }
                } else {
                  if (!cells[n + 2]) {       
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 40
                        return "."
                      } else { // 41
                        return "%"
                      }
                    } else {
                      if (!cells[n + 0]) { // 42
                        return "["
                      } else { // 43
                        return "$"
                      }
                    }
                  } else {
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 44
                        return "+"
                      } else { // 45
                        return "X"
                      }
                    } else {
                      if (!cells[n + 0]) { // 46
                        return "!"
                      } else { // 47
                        return "&"
                      }
                    }
                  }
                }
              } else {               
                if (!cells[n + 3]) { 
                  if (!cells[n + 2]) {       
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 48
                        return ';'
                      } else { // 49
                        return ":"
                      }
                    } else {
                      if (!cells[n + 0]) { // 50
                        return "4"
                      } else { // 51
                        return "\\"
                      }
                    }
                  } else {
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 52
                        return "0"
                      } else { // 53
                        return "Z"
                      }
                    } else {
                      if (!cells[n + 0]) { // 54
                        return "7"
                      } else { // 55
                        return "("
                      }
                    }
                  }
                } else {
                  if (!cells[n + 2]) {       
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 56
                        return "_"
                      } else { // 57
                        return "?"
                      }
                    } else {
                      if (!cells[n + 0]) { // 58
                        return "W"
                      } else { // 59
                        return "]"
                      }
                    }
                  } else {
                    if (!cells[n + 1]) {
                      if (!cells[n + 0]) { // 60
                        return "#"
                      } else { // 61
                        return "Y"
                      }
                    } else {
                      if (!cells[n + 0]) { // 62
                        return ")"
                      } else { // 63
                        return "="
                      }
                    }
                  }
                }
              }
            }
          }
        }

        function showSolution() {
          body.onmousedown = body.ontouchstart = body.onmousemove = body.ontouchmove = body.onmouseup = body.ontouchend = null

          document.querySelector(".red").innerHTML = "&nbsp;"

          document.querySelector("#cell_M").setAttributeNS(xlinkNS, "xlink:href", "#M")
          document.querySelector("#cell_P").setAttributeNS(xlinkNS, "xlink:href", "#P")
          document.querySelector("#cell_L").setAttributeNS(xlinkNS, "xlink:href", "#L")
          document.querySelector("#cell_E").setAttributeNS(xlinkNS, "xlink:href", "#E")
          document.querySelector("#cell_X").setAttributeNS(xlinkNS, "xlink:href", "")

          var decay = document.querySelector("#decay")
          decay.style.display = "block"
          var animations=document.querySelectorAll("#decay animate")
          for (var ii=0,animation;animation=animations[ii];ii+=1) {
            if (animation.beginElement){
              animation.beginElement()
            } else {
              decay.style.display = "none"
            }
          }

        setTimeout(function () {
          document.body.style.backgroundColor = "#000"
          document.querySelector("rect").setAttributeNS(null, "opacity", "0")
        }, 1000)
        }
      }
    }
  }

  function hrefIsFill(target) {
    if (target.getAttributeNS) {
      return (target.getAttributeNS(xlinkNS,"href") === "#fill")
    } else {
      // Internet Explorer
      var item=target.attributes.getNamedItemNS(xlinkNS,"href")
      return item.nodeValue === "#fill"
    }
  }
})()
</script>
</body>
</html>
